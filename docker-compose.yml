version: '3.8'

services:
  # Redis - Queue and caching
  redis:
    image: redis:7-alpine
    container_name: sreality-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # PostgreSQL - Scraper Database (Tier 1)
  postgres:
    image: postgres:15-alpine
    container_name: sreality-postgres
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=scraper_czech_sreality
      - POSTGRES_USER=landomo
      - POSTGRES_PASSWORD=${SCRAPER_DB_PASSWORD}
    volumes:
      - ./database/schema.sql:/docker-entrypoint-initdb.d/schema.sql
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U landomo"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Coordinator - Discovery (run manually or via scheduler)
  coordinator:
    build: .
    container_name: sreality-coordinator
    command: npm run coordinator
    environment:
      - REDIS_URL=redis://redis:6379
      - LANDOMO_API_URL=${LANDOMO_API_URL}
      - LANDOMO_API_KEY=${LANDOMO_API_KEY}
      - SCRAPER_DB_HOST=postgres
      - SCRAPER_DB_NAME=scraper_czech_sreality
      - SCRAPER_DB_USER=landomo
      - SCRAPER_DB_PASSWORD=${SCRAPER_DB_PASSWORD}
      - DEBUG=${DEBUG:-false}
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    restart: "no"  # Use external scheduler (cron, k8s CronJob, etc.)

  # Workers - Process details from queue (scale with replicas)
  worker:
    build: .
    command: npm run worker
    environment:
      - REDIS_URL=redis://redis:6379
      - LANDOMO_API_URL=${LANDOMO_API_URL}
      - LANDOMO_API_KEY=${LANDOMO_API_KEY}
      - SCRAPER_DB_HOST=postgres
      - SCRAPER_DB_NAME=scraper_czech_sreality
      - SCRAPER_DB_USER=landomo
      - SCRAPER_DB_PASSWORD=${SCRAPER_DB_PASSWORD}
      - REQUEST_DELAY_MS=${REQUEST_DELAY_MS:-2000}
      - DEBUG=${DEBUG:-false}
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    deploy:
      replicas: 3  # Run 3 workers in parallel
    restart: unless-stopped

  # Worker Verifier - Verify missing properties
  worker-verifier:
    build: .
    container_name: sreality-worker-verifier
    command: npm run worker:verifier
    environment:
      - REDIS_URL=redis://redis:6379
      - LANDOMO_API_URL=${LANDOMO_API_URL}
      - LANDOMO_API_KEY=${LANDOMO_API_KEY}
      - SCRAPER_DB_HOST=postgres
      - SCRAPER_DB_NAME=scraper_czech_sreality
      - SCRAPER_DB_USER=landomo
      - SCRAPER_DB_PASSWORD=${SCRAPER_DB_PASSWORD}
      - DEBUG=${DEBUG:-false}
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    restart: unless-stopped

  # Metrics Server - Prometheus metrics
  metrics:
    build: .
    container_name: sreality-metrics
    command: npm run metrics
    ports:
      - "9090:9090"
    environment:
      - REDIS_URL=redis://redis:6379
      - SCRAPER_DB_HOST=postgres
      - SCRAPER_DB_NAME=scraper_czech_sreality
      - SCRAPER_DB_USER=landomo
      - SCRAPER_DB_PASSWORD=${SCRAPER_DB_PASSWORD}
      - METRICS_PORT=9090
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    restart: unless-stopped

  # Queue Stats Monitor (optional)
  stats:
    build: .
    container_name: sreality-stats
    command: npm run queue:stats
    environment:
      - REDIS_URL=redis://redis:6379
    depends_on:
      redis:
        condition: service_healthy
    profiles:
      - tools  # Only run when explicitly requested

volumes:
  redis-data:
    driver: local
  postgres-data:
    driver: local

networks:
  default:
    name: sreality-network
